<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History Tutor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'scale-in': 'scaleIn 0.5s ease-out',
                        'bounce-short': 'bounceShort 0.5s ease-in-out 1'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideDown: { '0%': { transform: 'translateY(-10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideIn: { '0%': { transform: 'translateX(-10px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        bounceShort: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } }
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Play, Pause, Volume2, Loader2, Square, Search, ImageOff, Globe, ShieldAlert } from 'lucide-react';

        // --- API CONSTANTS ---
        // ‚ö†Ô∏è PASTE YOUR API KEY BETWEEN THE QUOTES BELOW ‚ö†Ô∏è
        const apiKey = "AIzaSyD8bIgFTBqzafeaVzfQRh26WDHRDzkifk4"; 

        const MODEL_TEXT = "gemini-2.0-flash"; 
        const MODEL_IMAGE = "imagen-3.0-generate-001";

        // --- HELPER FUNCTIONS ---

        const fetchWithRetry = async (url, options, retries = 2, delay = 1000) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                return await response.json();
            } catch (err) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                throw err;
            }
        };

        const HistoryGuide = () => {
            // --- STATE ---
            const [query, setQuery] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            
            // Content State
            const [fullAnswer, setFullAnswer] = useState('');
            const [isSafetyBlocked, setIsSafetyBlocked] = useState(false); 

            const [videoRecommendation, setVideoRecommendation] = useState(null); 
            const [sources, setSources] = useState([]);
            const [concepts, setConcepts] = useState([]);
            const [masteredConcepts, setMasteredConcepts] = useState(new Set());
            
            // Image State
            const [vibeImage, setVibeImage] = useState(null);
            const [isVibeLoading, setIsVibeLoading] = useState(false);
            const [imageSourceType, setImageSourceType] = useState(null);

            const [isFullAnswerUnlocked, setIsFullAnswerUnlocked] = useState(false);
            
            // Concept Interaction State
            const [activeConcept, setActiveConcept] = useState(null); 
            const [conceptExplanation, setConceptExplanation] = useState(null);
            const [isExplaining, setIsExplaining] = useState(false);

            // Feature States
            const [summary, setSummary] = useState(null);
            const [isSummarizing, setIsSummarizing] = useState(false);
            
            const [quizData, setQuizData] = useState(null);
            const [quizResult, setQuizResult] = useState(null); 
            const [isQuizLoading, setIsQuizLoading] = useState(false);
            const [selectedQuizOption, setSelectedQuizOption] = useState(null);

            // Speech State
            const [speechStatus, setSpeechStatus] = useState('idle');
            const [availableVoices, setAvailableVoices] = useState([]);
            const utteranceRef = useRef(null);

            // --- EFFECTS ---

            useEffect(() => {
                const updateVoices = () => {
                    const voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        setAvailableVoices(voices);
                    }
                };
                updateVoices();
                window.speechSynthesis.onvoiceschanged = updateVoices;
                return () => { window.speechSynthesis.cancel(); };
            }, []);

            // --- CORE LOGIC ---

            const checkGuardrails = async (userQuery) => {
                const payload = {
                    contents: [{ parts: [{ text: `You are a strict moderator for a children's history education app (Grade 6-10). Evaluate this query: "${userQuery}". Output ONLY one word: "ALLOWED" or "BLOCKED".
                    Rules for BLOCKING:
                    1. Block sexual content/adult themes.
                    2. Block modern celebrities/influencers.
                    3. Block non-historical queries.` }] }]
                };
                try {
                    const response = await fetchWithRetry(
                        `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:generateContent?key=${apiKey}`,
                        { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }
                    );
                    const decision = response.candidates?.[0]?.content?.parts?.[0]?.text?.trim().toUpperCase();
                    return decision === "ALLOWED";
                } catch (e) { return true; }
            };

            const handleSearch = async () => {
                if (!query.trim()) return;
                if (!apiKey) { alert("Please enter your API key!"); return; }
                
                setIsLoading(true);
                setLoadingMessage("Checking topic safety...");
                setFullAnswer('');
                setIsSafetyBlocked(false); 
                setVideoRecommendation(null);
                setSources([]);
                setConcepts([]);
                setMasteredConcepts(new Set());
                setVibeImage(null);
                setImageSourceType(null);
                setIsFullAnswerUnlocked(false);
                setActiveConcept(null);
                setConceptExplanation(null);
                setSummary(null);
                setQuizData(null);
                setQuizResult(null);
                setSelectedQuizOption(null);
                window.speechSynthesis.cancel();
                setSpeechStatus('idle');

                try {
                    const isSafe = await checkGuardrails(query);
                    if (!isSafe) {
                        setIsSafetyBlocked(true);
                        setIsLoading(false);
                        return; 
                    }

                    setLoadingMessage("Searching the Archives...");
                    const answerPayload = {
                        contents: [{ parts: [{ text: query }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: { parts: [{ text: "You are a history tutor. Structure: 1. INTRODUCTION. 2. HISTORICAL FLOW (arrows). 3. KEY POINTERS (numbered). 4. CONCLUSION. 5. Last line: '[VIDEO]: Title by Channel'. Keep PG." }] }
                    };

                    const answerData = await fetchWithRetry(
                        `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:generateContent?key=${apiKey}`,
                        { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(answerPayload) }
                    );

                    let answerText = answerData.candidates?.[0]?.content?.parts?.[0]?.text;
                    const grounding = answerData.candidates?.[0]?.groundingMetadata?.groundingAttributions || [];
                    if (!answerText) throw new Error("No answer.");

                    const videoRegex = /\[VIDEO\]:\s*(.*)/i;
                    const videoMatch = answerText.match(videoRegex);
                    if (videoMatch) {
                        setVideoRecommendation(videoMatch[1].trim());
                        answerText = answerText.replace(videoRegex, '').trim();
                    }

                    setFullAnswer(answerText);
                    setSources(grounding.map(g => g.web).filter(w => w));

                    setLoadingMessage("Extracting key concepts...");
                    const conceptPayload = {
                        contents: [{ parts: [{ text: `Extract 5 to 7 key concepts from this text as a JSON array of strings: ${answerText}` }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };
                    const conceptData = await fetchWithRetry(
                        `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:generateContent?key=${apiKey}`,
                        { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(conceptPayload) }
                    );
                    setConcepts(JSON.parse(conceptData.candidates[0].content.parts[0].text));
                    
                    generateVibeImage(query);

                } catch (error) {
                    console.error(error);
                    setFullAnswer("An error occurred.");
                    setIsFullAnswerUnlocked(true); 
                } finally {
                    setIsLoading(false);
                }
            };

            const generateVibeImage = async (userQuery) => {
                setIsVibeLoading(true);
                setVibeImage(null);
                
                try {
                    const promptPayload = { contents: [{ parts: [{ text: `Create a safe, artistic oil painting description for: "${userQuery}". No violence/modern figures. Max 20 words.` }] }] };
                    const promptData = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(promptPayload) });
                    const safePrompt = promptData.candidates?.[0]?.content?.parts?.[0]?.text || "Historical landscape";

                    const imagePayload = { instances: [{ prompt: safePrompt + ", oil painting style, cinematic lighting, museum quality" }], parameters: { sampleCount: 1, aspectRatio: "4:3" } };
                    const imageData = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_IMAGE}:predict?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(imagePayload) });

                    if (imageData.predictions?.[0]?.bytesBase64Encoded) {
                        setVibeImage(`data:image/png;base64,${imageData.predictions[0].bytesBase64Encoded}`);
                        setImageSourceType('ai');
                        setIsVibeLoading(false);
                        return; 
                    }
                } catch (e) { console.warn("AI Image failed, trying Wiki..."); }

                try {
                    const cleanQuery = userQuery.replace(/^(what|who|why|how|explain|describe|history of)\s+/i, '').replace(/\?/g, '').trim();
                    const wikiRes = await fetch(`https://en.wikipedia.org/w/api.php?action=query&generator=search&gsrsearch=${encodeURIComponent(cleanQuery)}&gsrlimit=1&prop=pageimages&pithumbsize=600&format=json&origin=*`).then(r => r.json());
                    const pages = wikiRes.query?.pages;
                    if (pages) {
                        const pageId = Object.keys(pages)[0];
                        const imageUrl = pages[pageId]?.thumbnail?.source;
                        if (imageUrl) {
                            setVibeImage(imageUrl);
                            setImageSourceType('wiki');
                            setIsVibeLoading(false);
                            return; 
                        }
                    }
                } catch (e) { console.warn("Wiki failed."); }

                setVibeImage("https://placehold.co/800x600/e6dcc3/5d4037?text=Historical+Scene+Unavailable&font=playfair-display");
                setImageSourceType('placeholder');
                setIsVibeLoading(false);
            };

            const handleConceptClick = async (concept) => {
                if (masteredConcepts.has(concept)) return;
                setActiveConcept(concept);
                setIsExplaining(true);
                setConceptExplanation(null);
                try {
                    const payload = { contents: [{ parts: [{ text: `Explain "${concept}" in 1 simple sentence (context: ${fullAnswer}). Keep it child-safe.` }] }] };
                    const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    setConceptExplanation(response.candidates?.[0]?.content?.parts?.[0]?.text);
                    const newMastered = new Set(masteredConcepts);
                    newMastered.add(concept);
                    setMasteredConcepts(newMastered);
                    if (newMastered.size === concepts.length) setTimeout(() => setIsFullAnswerUnlocked(true), 1000);
                } catch (e) { setConceptExplanation("Could not explain."); } 
                finally { setIsExplaining(false); }
            };

            const handleSummarize = async () => {
                setIsSummarizing(true);
                try {
                    const payload = { contents: [{ parts: [{ text: `Summarize this in 3 numbered points: ${fullAnswer}` }] }] };
                    const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    setSummary(response.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch (e) { console.error(e); } finally { setIsSummarizing(false); }
            };

            const handleQuiz = async () => {
                setIsQuizLoading(true);
                setQuizResult(null);
                setSelectedQuizOption(null);
                try {
                    const prompt = `Based on the text provided previously about ${query}, create 1 multiple choice question. 
                    Return strictly raw JSON (no markdown formatting) with this structure:
                    { "question": "...", "options": { "A": "...", "B": "...", "C": "...", "D": "..." }, "answer": "A" }`;

                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };

                    const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    let text = response.candidates[0].content.parts[0].text;
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    
                    setQuizData(JSON.parse(text));
                } catch (e) { console.error("Quiz Error", e); } finally { setIsQuizLoading(false); }
            };

            const startReading = () => {
                if (!fullAnswer) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(fullAnswer.replace(/\*\*/g, ''));
                utterance.rate = 0.95; 
                const voices = availableVoices.length > 0 ? availableVoices : window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.name.includes("Natural") && v.lang.includes("en")) || voices.find(v => v.name.includes("Google US English")) || voices.find(v => v.lang.includes("en"));
                if (preferredVoice) utterance.voice = preferredVoice;
                utterance.onend = () => setSpeechStatus('idle');
                utteranceRef.current = utterance;
                window.speechSynthesis.speak(utterance);
                setSpeechStatus('playing');
            };
            
            const stopReading = () => { window.speechSynthesis.cancel(); setSpeechStatus('idle'); };
            const pauseReading = () => { window.speechSynthesis.pause(); setSpeechStatus('paused'); };
            const resumeReading = () => { window.speechSynthesis.resume(); setSpeechStatus('playing'); };

            const renderFormattedText = (text) => {
                if (!text) return null;
                const parts = text.split(/(\*\*.*?\*\*)/g); 
                return parts.map((part, index) => {
                    if (part.startsWith('**') && part.endsWith('**')) return <strong key={index} className="text-stone-900">{part.slice(2, -2)}</strong>;
                    return <span key={index}>{part}</span>;
                });
            };
            
            return (
                <div className="min-h-screen p-4 sm:p-8 bg-[#fdfbf6]" style={{ fontFamily: '"EB Garamond", serif' }}>
                <style>{` @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600;700&display=swap'); .loader { border-top-color: #854d0e; animation: spin 1s linear infinite; } @keyframes spin { 100% { transform: rotate(360deg); } } `}</style>

                <div className="max-w-4xl mx-auto">
                    <header className="text-center mb-8">
                    <h1 className="text-4xl font-extrabold text-stone-800">AI by Aksh & Anay üèõÔ∏è</h1>
                    <p className="text-stone-600 mt-2">Ask any historical question to get a grounded answer and unlock powerful learning tools.</p>
                    </header>

                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <label className="block text-lg font-medium text-gray-700 mb-3">Your History Question:</label>
                    <textarea
                        value={query}
                        onChange={(e) => setQuery(e.target.value)}
                        rows="3"
                        placeholder="e.g., What caused the fall of the Roman Empire?"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition outline-none resize-none font-sans"
                    />
                    <div className="flex justify-end mt-4">
                        <button onClick={handleSearch} disabled={isLoading} className="px-6 py-3 bg-stone-700 text-white font-semibold rounded-lg shadow-md hover:bg-stone-800 transition flex items-center disabled:opacity-70">
                        {isLoading ? <><span className="mr-2">{loadingMessage}</span><Loader2 className="w-5 h-5 animate-spin" /></> : "Get Historical Answer"}
                        </button>
                    </div>
                    </div>

                    {/* SAFETY BLOCK MESSAGE */}
                    {isSafetyBlocked && (
                         <div className="bg-red-50 border-l-4 border-red-500 p-6 rounded-r-xl shadow-md animate-slide-down mb-8">
                            <div className="flex items-center text-red-800 font-bold text-lg mb-2">
                                <ShieldAlert className="w-6 h-6 mr-2"/> Topic Out of Scope
                            </div>
                            <p className="text-red-700">
                                I am a dedicated History Tutor for students. I can only answer questions about <strong>historical events, figures, and civilizations</strong>. 
                                <br/><br/>
                                Please ask me something else, like <em>"Who was Ashoka?"</em> or <em>"The Industrial Revolution"</em>.
                            </p>
                         </div>
                    )}

                    {fullAnswer && !isSafetyBlocked && (
                    <div className="space-y-6 animate-fade-in">
                        
                        <div className="bg-white p-4 rounded-xl shadow-lg border-2 border-dashed border-gray-300">
                            <h2 className="text-xl font-semibold text-gray-700 mb-3 flex items-center"><span className="mr-2">üé®</span> Historical Scene</h2>
                            <div className="w-full aspect-video bg-gray-50 rounded-lg overflow-hidden flex items-center justify-center relative group">
                                {isVibeLoading ? (
                                    <div className="text-center"><Loader2 className="w-8 h-8 text-amber-700 animate-spin mx-auto mb-2" /><p className="text-gray-400">Finding the best image...</p></div>
                                ) : vibeImage ? (
                                    <>
                                        {/* FIXED: object-contain */}
                                        <img src={vibeImage} alt="Historical Topic" className="w-full h-full object-contain bg-black/5 animate-scale-in" />
                                        {imageSourceType === 'wiki' && <div className="absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded flex items-center backdrop-blur-sm"><Globe className="w-3 h-3 mr-1"/> Wikipedia Source</div>}
                                        {imageSourceType === 'placeholder' && <div className="absolute bottom-2 right-2 bg-stone-700/80 text-white text-xs px-2 py-1 rounded flex items-center backdrop-blur-sm"><ImageOff className="w-3 h-3 mr-1"/> Image Unavailable</div>}
                                    </>
                                ) : <p className="text-gray-400">Waiting for input...</p>}
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <h2 className="text-2xl font-bold text-amber-800 mb-4 flex items-center"><span className="mr-2">üîç</span> Knowledge Pre-check</h2>
                            <p className="text-stone-600 mb-4">{isFullAnswerUnlocked ? "‚úÖ Mastery Complete! The full answer is unlocked." : "Click each key concept below to get a quick definition. Master all concepts to unlock the full historical answer."}</p>
                            <div className="flex flex-wrap gap-3 mb-6">
                                {concepts.map((concept, idx) => {
                                    const isMastered = masteredConcepts.has(concept);
                                    const isActive = activeConcept === concept;
                                    return (
                                        <button key={idx} onClick={() => handleConceptClick(concept)} disabled={isMastered} className={`px-4 py-2 rounded-full font-semibold border-2 transition-all duration-200 ${isMastered ? 'bg-emerald-500 text-white border-emerald-600 cursor-default' : isActive ? 'bg-amber-100 text-amber-900 border-amber-700 scale-105 shadow-md' : 'bg-amber-100 text-amber-800 border-transparent hover:bg-amber-200 hover:scale-105'}`}>{concept} {isMastered && "‚úì"}</button>
                                    );
                                })}
                            </div>
                            {(activeConcept || conceptExplanation || isExplaining) && (
                                <div className="p-4 border-l-4 border-amber-500 bg-amber-50 text-amber-900 rounded-r-lg animate-slide-in">
                                    <h3 className="font-bold text-lg mb-1">{isExplaining ? `Defining "${activeConcept}"...` : `Concept: ${activeConcept}`}</h3>
                                    <div className="text-lg">{isExplaining ? <div className="flex items-center gap-2"><Loader2 className="w-4 h-4 animate-spin" /> Consulting the archives...</div> : conceptExplanation}</div>
                                </div>
                            )}
                        </div>

                        {isFullAnswerUnlocked && (
                            <div className="bg-white p-6 rounded-xl shadow-lg transition duration-500 animate-slide-up">
                                <h2 className="text-2xl font-semibold text-gray-800 mb-4">Historical Answer (Unlocked!)</h2>
                                <div className="text-gray-700 text-lg leading-relaxed text-justify whitespace-pre-line font-sans">{renderFormattedText(fullAnswer)}</div>
                                {videoRecommendation && (
                                    <div className="mt-8"><a href={`https://www.youtube.com/results?search_query=${encodeURIComponent(videoRecommendation)}`} target="_blank" rel="noopener noreferrer" className="block bg-red-50 border border-red-200 p-4 rounded-xl hover:bg-red-100 transition-all flex items-center gap-4 group shadow-sm hover:shadow-md"><div className="bg-red-600 text-white p-3 rounded-full group-hover:scale-110 transition-transform shrink-0"><Play className="w-6 h-6 fill-current" /></div><div><h3 className="font-bold text-red-900 text-lg">üé• Recommended Video</h3><p className="text-red-800 font-medium">{videoRecommendation}</p><span className="text-xs text-red-600 mt-1 flex items-center gap-1">Click to watch on YouTube <Search className="w-3 h-3"/></span></div></a></div>
                                )}
                                {sources.length > 0 && (<div className="mt-6 pt-4 border-t border-gray-200 text-sm text-gray-500"><span className="font-bold">Sources: </span>{sources.map((s, i) => (<span key={i}><a href={s.uri} target="_blank" rel="noreferrer" className="text-amber-700 hover:underline">{s.title}</a>{i < sources.length - 1 && " | "}</span>))}</div>)}
                            </div>
                        )}

                        {isFullAnswerUnlocked && (
                            <div className="bg-white p-6 rounded-xl shadow-lg animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <button onClick={handleSummarize} disabled={isSummarizing} className="bg-blue-700 hover:bg-blue-800 text-white font-semibold py-3 rounded-lg flex items-center justify-center disabled:opacity-70">{isSummarizing ? <Loader2 className="w-5 h-5 animate-spin" /> : <><span className="mr-2">‚ú®</span> Summarize Key Points</>}</button>
                                    {speechStatus === 'idle' ? ( <button onClick={startReading} className="bg-teal-700 hover:bg-teal-800 text-white font-semibold py-3 rounded-lg flex items-center justify-center transition-colors"><Volume2 className="w-5 h-5 mr-2" /> Read Aloud</button> ) : ( <div className="flex items-center gap-2"><button onClick={speechStatus === 'playing' ? pauseReading : resumeReading} className="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 rounded-lg flex items-center justify-center transition-colors">{speechStatus === 'playing' ? <><Pause className="w-4 h-4 mr-2" /> Pause</> : <><Play className="w-4 h-4 mr-2" /> Resume</>}</button><button onClick={stopReading} className="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center transition-colors"><Square className="w-5 h-5 fill-current" /></button></div> )}
                                    <button onClick={handleQuiz} disabled={isQuizLoading} className="bg-orange-700 hover:bg-orange-800 text-white font-semibold py-3 rounded-lg flex items-center justify-center disabled:opacity-70">{isQuizLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <><span className="mr-2">‚ùì</span> Generate Quiz</>}</button>
                                </div>
                                {/* FIXED: Replaced formatting check with pure clean text */}
                                {summary && (<div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-300 animate-slide-down"><h3 className="font-bold text-blue-800 mb-2">Key Takeaways:</h3><div className="whitespace-pre-line text-blue-900 font-sans">{summary.replace(/\*/g, '')}</div></div>)}
                                {quizData && (
                                    <div className="mt-4 p-4 bg-orange-50 rounded-lg border border-orange-300 animate-slide-down">
                                        <h3 className="font-bold text-orange-800 mb-3">Knowledge Check:</h3><p className="font-semibold mb-3 text-orange-900 font-sans">{quizData.question}</p>
                                        <div className="space-y-2">{Object.entries(quizData.options).map(([key, val]) => { let btnClass = "w-full text-left p-3 border rounded-lg transition duration-150 bg-white "; if (quizResult) { if (key === quizData.answer) btnClass += "bg-green-200 border-green-500 text-green-900"; else if (key === selectedQuizOption && key !== quizData.answer) btnClass += "bg-orange-200 border-orange-500 text-orange-900"; else btnClass += "border-orange-200 opacity-60"; } else { btnClass += "border-orange-300 hover:bg-orange-100 text-stone-800"; } return ( <button key={key} onClick={() => { setSelectedQuizOption(key); setQuizResult(key === quizData.answer ? 'correct' : 'incorrect'); }} disabled={!!quizResult} className={btnClass} > <span className="font-bold">{key}:</span> {val} </button> ); })}</div>
                                        {quizResult && (<div className="mt-3 font-bold text-lg animate-bounce-short">{quizResult === 'correct' ? <span className="text-green-600">‚úÖ Correct! Excellent recall.</span> : <span className="text-orange-600">‚ùå Incorrect. The correct answer was {quizData.answer}.</span>}</div>)}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    )}
                </div>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<HistoryGuide />);
    </script>
</body>

</html>
